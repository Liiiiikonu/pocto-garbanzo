<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Radar — Live Materials Science Feed</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #07080f;
    --bg-subtle: #0c0e18;
    --surface: rgba(17, 20, 35, 0.7);
    --surface-solid: #111423;
    --surface2: rgba(25, 30, 52, 0.6);
    --surface-hover: rgba(30, 35, 60, 0.8);
    --glass: rgba(255, 255, 255, 0.03);
    --glass-border: rgba(255, 255, 255, 0.06);
    --border: rgba(255, 255, 255, 0.07);
    --border-hover: rgba(255, 255, 255, 0.12);
    --text: #eaf0f6;
    --text-secondary: #a0aec0;
    --text-muted: #6b7a90;
    --accent: #6c63ff;
    --accent-light: #8b83ff;
    --accent-glow: rgba(108, 99, 255, 0.15);
    --accent-glow-strong: rgba(108, 99, 255, 0.3);
    --cyan: #22d3ee;
    --cyan-glow: rgba(34, 211, 238, 0.12);
    --green: #34d399;
    --green-glow: rgba(52, 211, 153, 0.12);
    --amber: #fbbf24;
    --amber-glow: rgba(251, 191, 36, 0.1);
    --rose: #fb7185;
    --rose-glow: rgba(251, 113, 133, 0.12);
    --orange: #fb923c;
    --orange-glow: rgba(251, 146, 60, 0.12);
    --radius: 14px;
    --radius-sm: 8px;
    --radius-lg: 20px;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 20px rgba(0,0,0,0.3);
    --shadow-lg: 0 8px 40px rgba(0,0,0,0.4);
    --shadow-glow: 0 0 30px rgba(108, 99, 255, 0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
    overflow-x: hidden;
  }

  /* Background gradient mesh */
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background:
      radial-gradient(ellipse 600px 600px at 20% 20%, rgba(108, 99, 255, 0.06), transparent),
      radial-gradient(ellipse 500px 500px at 80% 10%, rgba(34, 211, 238, 0.04), transparent),
      radial-gradient(ellipse 400px 400px at 50% 80%, rgba(251, 113, 133, 0.03), transparent);
    z-index: -1;
    pointer-events: none;
  }

  /* ── Header ── */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid var(--glass-border);
    padding: 0.9rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
    background: rgba(7, 8, 15, 0.8);
    backdrop-filter: blur(20px) saturate(1.5);
    -webkit-backdrop-filter: blur(20px) saturate(1.5);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: .7rem;
    font-size: 1.2rem;
    font-weight: 800;
    letter-spacing: -.03em;
    background: linear-gradient(135deg, var(--accent-light), var(--cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .logo-icon {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--cyan));
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 20px rgba(108, 99, 255, 0.3);
  }

  .logo-icon svg { flex-shrink: 0; }

  .header-right {
    display: flex;
    align-items: center;
    gap: .75rem;
    font-size: .8rem;
    color: var(--text-muted);
  }

  .live-badge {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    font-size: .7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .08em;
    color: var(--green);
    background: var(--green-glow);
    border: 1px solid rgba(52, 211, 153, 0.2);
    padding: .25rem .65rem;
    border-radius: 999px;
  }

  .live-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s ease-in-out infinite;
    box-shadow: 0 0 6px var(--green);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px var(--green); }
    50% { opacity: .4; box-shadow: 0 0 2px var(--green); }
  }

  .sort-select {
    background: var(--bg-subtle);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: .4rem .7rem;
    border-radius: var(--radius-sm);
    font-size: .78rem;
    font-family: inherit;
    cursor: pointer;
    transition: all .25s ease;
  }

  .sort-select:hover { border-color: var(--border-hover); color: var(--text); }
  .sort-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

  /* ── Main layout ── */
  main {
    max-width: 900px;
    margin: 0 auto;
    padding: 2.5rem 1.5rem 5rem;
  }

  /* ── Hero / Intro ── */
  .intro {
    text-align: center;
    margin-bottom: 2.5rem;
    position: relative;
  }

  .intro h2 {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -.04em;
    margin-bottom: .5rem;
    background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .intro p {
    color: var(--text-muted);
    font-size: .95rem;
    max-width: 500px;
    margin: 0 auto;
  }

  /* ── Topic pills ── */
  .topics {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    justify-content: center;
    margin-bottom: 1.5rem;
  }

  .pill {
    padding: .5rem 1.15rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--glass);
    color: var(--text-muted);
    font-size: .82rem;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    transition: all .25s cubic-bezier(.4,0,.2,1);
    user-select: none;
    white-space: nowrap;
    backdrop-filter: blur(4px);
  }

  .pill:hover {
    border-color: var(--accent);
    color: var(--text);
    background: var(--accent-glow);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm), 0 0 15px var(--accent-glow);
  }

  .pill.active {
    border-color: var(--accent);
    background: linear-gradient(135deg, var(--accent-glow-strong), var(--accent-glow));
    color: var(--accent-light);
    font-weight: 600;
    box-shadow: 0 0 20px var(--accent-glow);
  }

  .pill:disabled { opacity: .4; cursor: not-allowed; transform: none; }

  /* ── Filters bar ── */
  .filters-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: .75rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: .4rem;
    font-size: .78rem;
    color: var(--text-muted);
  }

  .filter-group label {
    font-weight: 500;
    letter-spacing: .02em;
  }

  .filter-select {
    background: var(--bg-subtle);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: .35rem .55rem;
    border-radius: var(--radius-sm);
    font-size: .78rem;
    font-family: inherit;
    cursor: pointer;
    transition: all .25s ease;
  }

  .filter-select:hover { border-color: var(--border-hover); }
  .filter-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

  .filter-divider {
    width: 1px;
    height: 18px;
    background: var(--border);
    margin: 0 .25rem;
  }

  .filter-checkbox {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    cursor: pointer;
    font-size: .78rem;
    color: var(--text-muted);
    transition: color .2s;
  }

  .filter-checkbox:hover { color: var(--text-secondary); }

  .filter-checkbox input[type="checkbox"] {
    accent-color: var(--accent);
    width: 14px;
    height: 14px;
    cursor: pointer;
  }

  /* ── Result count + refresh bar ── */
  .result-info {
    display: none;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.25rem;
    font-size: .78rem;
    color: var(--text-muted);
  }

  .result-info.visible { display: flex; }

  .refresh-bar {
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  .refresh-timer {
    font-variant-numeric: tabular-nums;
    font-family: 'JetBrains Mono', monospace;
    font-size: .72rem;
    opacity: .7;
  }

  .refresh-btn {
    background: var(--glass);
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: .25rem .6rem;
    border-radius: var(--radius-sm);
    font-size: .72rem;
    font-family: inherit;
    cursor: pointer;
    transition: all .25s ease;
  }

  .refresh-btn:hover {
    border-color: var(--accent);
    color: var(--accent-light);
    background: var(--accent-glow);
  }

  .refresh-btn:disabled { opacity: .3; cursor: not-allowed; }

  /* ── Feed ── */
  #feed {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  /* ── Hero card (first result) ── */
  .card-hero {
    background: linear-gradient(145deg, var(--surface), var(--surface2));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: 2rem 2rem 1.75rem;
    transition: all .35s cubic-bezier(.4,0,.2,1);
    animation: fadeUp .5s ease both;
    position: relative;
    overflow: hidden;
  }

  .card-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--cyan), var(--accent));
    background-size: 200% 100%;
    animation: shimmerGradient 3s ease infinite;
  }

  @keyframes shimmerGradient {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .card-hero:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg), var(--shadow-glow);
  }

  .card-hero .card-topic { font-size: .72rem; }

  .card-hero h3 {
    font-size: 1.3rem;
    font-weight: 700;
    line-height: 1.4;
    margin-bottom: .5rem;
  }

  .card-hero .meta { font-size: .82rem; }
  .card-hero .abstract { font-size: .92rem; line-height: 1.75; }

  .hero-label {
    display: inline-flex;
    align-items: center;
    gap: .25rem;
    font-size: .6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .1em;
    color: var(--cyan);
    background: var(--cyan-glow);
    border: 1px solid rgba(34, 211, 238, 0.2);
    padding: .15rem .5rem;
    border-radius: 4px;
    margin-right: .5rem;
  }

  /* ── Regular card ── */
  .card {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    transition: all .3s cubic-bezier(.4,0,.2,1);
    animation: fadeUp .4s ease both;
    position: relative;
    backdrop-filter: blur(4px);
  }

  .card:hover {
    border-color: rgba(108, 99, 255, 0.3);
    background: var(--surface-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md), 0 0 20px var(--accent-glow);
  }

  .card-badges {
    display: flex;
    align-items: center;
    gap: .4rem;
    margin-bottom: .5rem;
    flex-wrap: wrap;
  }

  .card-topic {
    display: inline-block;
    font-size: .65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .07em;
    color: var(--accent-light);
    opacity: .8;
  }

  .badge-hot {
    display: inline-flex;
    align-items: center;
    gap: .25rem;
    font-size: .6rem;
    font-weight: 700;
    color: var(--orange);
    background: var(--orange-glow);
    border: 1px solid rgba(251, 146, 60, 0.25);
    padding: .12rem .45rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: .05em;
    animation: hotPulse 2s ease-in-out infinite;
  }

  @keyframes hotPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.2); }
    50% { box-shadow: 0 0 8px 2px rgba(251, 146, 60, 0.15); }
  }

  .card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: .75rem;
    margin-bottom: .3rem;
  }

  .card h3 {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.45;
    flex: 1;
    letter-spacing: -.01em;
  }

  .card h3 a {
    color: var(--text);
    text-decoration: none;
    transition: color .2s;
  }

  .card h3 a:hover { color: var(--accent-light); }

  .card .meta {
    font-size: .78rem;
    color: var(--text-muted);
    margin-bottom: .6rem;
    display: flex;
    align-items: center;
    gap: .5rem;
    flex-wrap: wrap;
  }

  .meta-dot {
    width: 3px;
    height: 3px;
    border-radius: 50%;
    background: var(--text-muted);
    opacity: .5;
    flex-shrink: 0;
  }

  .abstract {
    font-size: .88rem;
    color: var(--text-secondary);
    line-height: 1.7;
    padding-top: .35rem;
    border-top: 1px solid var(--border);
    margin-top: .4rem;
  }

  .card-stats {
    display: flex;
    align-items: center;
    gap: .4rem;
    flex-shrink: 0;
  }

  .cite-count {
    font-size: .68rem;
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
    color: var(--amber);
    background: var(--amber-glow);
    border: 1px solid rgba(251, 191, 36, 0.18);
    padding: .15rem .5rem;
    border-radius: 999px;
    white-space: nowrap;
  }

  .open-access {
    display: inline-flex;
    align-items: center;
    gap: .2rem;
    font-size: .6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .06em;
    color: var(--green);
    background: var(--green-glow);
    border: 1px solid rgba(52, 211, 153, 0.18);
    padding: .12rem .4rem;
    border-radius: 4px;
    margin-left: .5rem;
    vertical-align: middle;
  }

  .year-badge {
    font-size: .65rem;
    font-weight: 500;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-muted);
    background: var(--glass);
    border: 1px solid var(--border);
    padding: .1rem .4rem;
    border-radius: 4px;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ── Loading skeleton ── */
  .skeleton {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
  }

  .skeleton-line {
    height: 14px;
    border-radius: 6px;
    background: linear-gradient(90deg, var(--surface2) 25%, rgba(255,255,255,0.04) 50%, var(--surface2) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease infinite;
    margin-bottom: .65rem;
  }

  .skeleton-line:nth-child(1) { width: 25%; height: 10px; }
  .skeleton-line:nth-child(2) { width: 85%; }
  .skeleton-line:nth-child(3) { width: 55%; }
  .skeleton-line:nth-child(4) { width: 92%; margin-bottom: 0; }

  .skeleton-hero {
    background: linear-gradient(145deg, var(--surface), var(--surface2));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: 2rem;
  }

  .skeleton-hero .skeleton-line:nth-child(2) { height: 20px; }

  @keyframes shimmer {
    0%   { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* ── Empty / Error ── */
  .empty-state {
    text-align: center;
    padding: 5rem 1rem;
    color: var(--text-muted);
  }

  .empty-state svg { margin-bottom: 1.25rem; opacity: .3; }
  .empty-state p { font-size: .95rem; }

  .error-banner {
    background: var(--rose-glow);
    border: 1px solid rgba(251, 113, 133, 0.25);
    color: var(--rose);
    padding: .75rem 1rem;
    border-radius: var(--radius);
    font-size: .85rem;
    margin-bottom: 1rem;
    display: none;
    backdrop-filter: blur(4px);
  }

  /* ── Footer ── */
  footer {
    text-align: center;
    padding: 2rem 1.5rem;
    font-size: .75rem;
    color: var(--text-muted);
    border-top: 1px solid var(--border);
  }

  footer a {
    color: var(--accent-light);
    text-decoration: none;
    transition: color .2s;
  }

  footer a:hover { color: var(--cyan); text-decoration: underline; }

  /* ── Responsive ── */
  @media (max-width: 640px) {
    header { padding: .75rem 1rem; }
    main { padding: 1.5rem 1rem 3rem; }
    .intro h2 { font-size: 1.5rem; }
    .card-hero { padding: 1.5rem; }
    .card-hero h3 { font-size: 1.1rem; }
    .card-header { flex-direction: column; gap: .5rem; }
    .filters-bar { flex-direction: column; gap: .6rem; }
    .filter-divider { display: none; }
  }

  /* ── Scrollbar ── */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

  /* ── Selection ── */
  ::selection {
    background: var(--accent-glow-strong);
    color: var(--text);
  }
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-icon">
      <svg width="18" height="18" viewBox="0 0 28 28" fill="none">
        <circle cx="14" cy="14" r="10" stroke="#fff" stroke-width="2.5" stroke-opacity="0.9"/>
        <circle cx="14" cy="14" r="3.5" fill="#fff" fill-opacity="0.9"/>
        <line x1="14" y1="2" x2="14" y2="7" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-opacity="0.7"/>
        <line x1="24" y1="8" x2="19.5" y2="11" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-opacity="0.7"/>
        <line x1="24" y1="20" x2="19.5" y2="17" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-opacity="0.7"/>
        <line x1="14" y1="26" x2="14" y2="21" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-opacity="0.7"/>
        <line x1="4" y1="20" x2="8.5" y2="17" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-opacity="0.7"/>
        <line x1="4" y1="8" x2="8.5" y2="11" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-opacity="0.7"/>
      </svg>
    </div>
    Research Radar
  </div>
  <div class="header-right">
    <div class="live-badge">
      <div class="live-dot"></div>
      Live
    </div>
    <select class="sort-select" id="sortSelect" title="Sort results">
      <option value="hot">Hottest</option>
      <option value="recent">Most Recent</option>
      <option value="cited">Most Cited</option>
      <option value="relevant">Most Relevant</option>
    </select>
  </div>
</header>

<!-- Main -->
<main>
  <div class="intro">
    <h2>Discover Fresh Research</h2>
    <p>Real-time papers from OpenAlex. Auto-refreshes every 5 minutes.</p>
  </div>

  <!-- Topics -->
  <div class="topics" id="topics"></div>

  <!-- Filters -->
  <div class="filters-bar" id="filtersBar">
    <div class="filter-group">
      <label>From</label>
      <select class="filter-select" id="yearFrom" title="Filter from year"></select>
    </div>
    <div class="filter-group">
      <label>To</label>
      <select class="filter-select" id="yearTo" title="Filter to year"></select>
    </div>
    <div class="filter-divider"></div>
    <label class="filter-checkbox">
      <input type="checkbox" id="oaOnly"> Open Access only
    </label>
  </div>

  <!-- Error banner -->
  <div class="error-banner" id="errorBanner"></div>

  <!-- Result info + refresh -->
  <div class="result-info" id="resultInfo">
    <span id="resultCount"></span>
    <div class="refresh-bar">
      <span class="refresh-timer" id="refreshTimer"></span>
      <button class="refresh-btn" id="refreshBtn" title="Refresh now">Refresh</button>
    </div>
  </div>

  <!-- Feed -->
  <div id="feed">
    <div class="empty-state">
      <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <p>Select a research topic above to explore.</p>
    </div>
  </div>
</main>

<footer>
  Data from <a href="https://openalex.org" target="_blank" rel="noopener">OpenAlex</a> —
  an open catalog of the world's scholarly works.
</footer>

<script>
// ─── Config ───
const TOPICS = [
  { label: "High-Entropy Alloys", search: "high-entropy alloys", concepts: "C2778407723" },
  { label: "Electrocatalysis", search: "electrocatalysis", concepts: "C159467904" },
  { label: "ML for Materials", search: "machine learning materials science materials discovery" },
  { label: "AI in Science", search: "artificial intelligence scientific discovery research" },
  { label: "Engineering Physics", search: "engineering physics" },
  { label: "Trending in MatSci", search: "materials science", concepts: "C192562407" },
];

const OPENALEX_BASE = "https://api.openalex.org/works";
const PER_PAGE = 25;
const DISPLAY_COUNT = 15;
const REFRESH_INTERVAL = 5 * 60 * 1000;

// ─── State ───
let activeTopic = null;
let loading = false;
const cache = {};
let refreshCountdown = null;
let refreshIntervalId = null;
let countdownIntervalId = null;

// ─── DOM refs ───
const topicsEl     = document.getElementById("topics");
const feedEl       = document.getElementById("feed");
const errorBanner  = document.getElementById("errorBanner");
const sortSelect   = document.getElementById("sortSelect");
const resultInfo   = document.getElementById("resultInfo");
const resultCount  = document.getElementById("resultCount");
const refreshTimer = document.getElementById("refreshTimer");
const refreshBtn   = document.getElementById("refreshBtn");
const yearFrom     = document.getElementById("yearFrom");
const yearTo       = document.getElementById("yearTo");
const oaOnly       = document.getElementById("oaOnly");

// ─── Init ───
(function init() {
  populateYearFilters();
  renderTopics();

  sortSelect.addEventListener("change", () => {
    if (activeTopic !== null) {
      bustCacheAndReload();
    }
  });

  yearFrom.addEventListener("change", () => {
    if (activeTopic !== null) bustCacheAndReload();
  });

  yearTo.addEventListener("change", () => {
    if (activeTopic !== null) bustCacheAndReload();
  });

  oaOnly.addEventListener("change", () => {
    if (activeTopic !== null) bustCacheAndReload();
  });

  refreshBtn.addEventListener("click", () => {
    if (activeTopic !== null && !loading) forceRefresh();
  });

  selectTopic(5);
})();

function bustCacheAndReload() {
  delete cache[cacheKeyFor(activeTopic)];
  selectTopic(activeTopic);
}

function populateYearFilters() {
  const currentYear = new Date().getFullYear();
  const startYear = 2015;

  // "From" defaults to 6 months logic, but we provide year options
  yearFrom.innerHTML = '';
  yearTo.innerHTML = '';

  for (let y = currentYear; y >= startYear; y--) {
    yearFrom.innerHTML += `<option value="${y}"${y === currentYear - 1 ? ' selected' : ''}>${y}</option>`;
    yearTo.innerHTML += `<option value="${y}"${y === currentYear ? ' selected' : ''}>${y}</option>`;
  }
}

function cacheKeyFor(index) {
  return TOPICS[index].label + "|" + sortSelect.value + "|" + yearFrom.value + "-" + yearTo.value + "|" + oaOnly.checked;
}

// ─── Auto-refresh ───
function startAutoRefresh() {
  stopAutoRefresh();
  refreshCountdown = REFRESH_INTERVAL / 1000;
  updateCountdownDisplay();

  countdownIntervalId = setInterval(() => {
    refreshCountdown--;
    updateCountdownDisplay();
  }, 1000);

  refreshIntervalId = setTimeout(() => {
    forceRefresh();
  }, REFRESH_INTERVAL);
}

function stopAutoRefresh() {
  clearTimeout(refreshIntervalId);
  clearInterval(countdownIntervalId);
  refreshIntervalId = null;
  countdownIntervalId = null;
}

function updateCountdownDisplay() {
  if (refreshCountdown <= 0) {
    refreshTimer.textContent = "refreshing\u2026";
    return;
  }
  const m = Math.floor(refreshCountdown / 60);
  const s = refreshCountdown % 60;
  refreshTimer.textContent = `${m}:${s.toString().padStart(2, "0")}`;
}

function forceRefresh() {
  if (activeTopic === null || loading) return;
  delete cache[cacheKeyFor(activeTopic)];
  selectTopic(activeTopic);
}

// ─── Render topic pills ───
function renderTopics() {
  topicsEl.innerHTML = "";
  TOPICS.forEach((t, i) => {
    const btn = document.createElement("button");
    btn.className = "pill";
    btn.textContent = t.label;
    btn.addEventListener("click", () => selectTopic(i));
    topicsEl.appendChild(btn);
  });
}

function updatePillStates() {
  const pills = topicsEl.querySelectorAll(".pill");
  pills.forEach((p, i) => {
    p.classList.toggle("active", i === activeTopic);
    p.disabled = loading;
  });
  refreshBtn.disabled = loading;
}

// ─── Select topic ───
async function selectTopic(index) {
  if (loading) return;

  hideError();
  activeTopic = index;
  const topic = TOPICS[index];
  const sort = sortSelect.value;
  const key = cacheKeyFor(index);

  if (cache[key] && Date.now() - cache[key].ts < REFRESH_INTERVAL) {
    renderCards(cache[key].cards, topic.label, cache[key].totalCount);
    updatePillStates();
    startAutoRefresh();
    return;
  }

  loading = true;
  updatePillStates();
  showSkeletons();

  try {
    const { papers, totalCount } = await fetchFromOpenAlex(topic, sort);
    cache[key] = { cards: papers, ts: Date.now(), totalCount };
    renderCards(papers, topic.label, totalCount);
    startAutoRefresh();
  } catch (err) {
    showError(err.message || "Something went wrong.");
    feedEl.innerHTML = "";
    resultInfo.classList.remove("visible");
  } finally {
    loading = false;
    updatePillStates();
  }
}

// ─── Build OpenAlex URL ───
function buildOpenAlexUrl(topic, sort) {
  const params = new URLSearchParams();
  params.set("per_page", PER_PAGE);
  params.set("mailto", "research-radar@users.noreply.github.com");

  // Use year filters
  const fromYear = parseInt(yearFrom.value);
  const toYear = parseInt(yearTo.value);
  const fromDate = `${fromYear}-01-01`;
  const toDate = `${toYear}-12-31`;

  let filter = `from_publication_date:${fromDate},to_publication_date:${toDate},type:article|review`;

  if (topic.concepts) {
    filter += `,concepts.id:${topic.concepts}`;
  }

  if (oaOnly.checked) {
    filter += `,open_access.is_oa:true`;
  }

  params.set("filter", filter);
  params.set("search", topic.search);

  switch (sort) {
    case "hot":
      params.set("sort", "cited_by_count:desc");
      break;
    case "cited":
      params.set("sort", "cited_by_count:desc");
      break;
    case "relevant":
      params.set("sort", "relevance_score:desc");
      break;
    case "recent":
    default:
      params.set("sort", "publication_date:desc");
      break;
  }

  return `${OPENALEX_BASE}?${params.toString()}`;
}

// ─── Fetch from OpenAlex ───
async function fetchFromOpenAlex(topic, sort) {
  const url = buildOpenAlexUrl(topic, sort);
  const resp = await fetch(url);

  if (!resp.ok) {
    throw new Error(`OpenAlex returned ${resp.status}. Try again in a moment.`);
  }

  const data = await resp.json();
  const totalCount = data.meta?.count || 0;

  let papers = (data.results || []).map(work => {
    const authors = (work.authorships || [])
      .slice(0, 4)
      .map(a => a.author?.display_name)
      .filter(Boolean)
      .join(", ");
    const authorSuffix = (work.authorships || []).length > 4 ? " et al." : "";

    let url = "";
    if (work.doi) url = work.doi;
    else if (work.primary_location?.landing_page_url) url = work.primary_location.landing_page_url;
    else if (work.ids?.openalex) url = work.ids.openalex;

    const source = work.primary_location?.source?.display_name || "";
    const pubDate = work.publication_date || "";

    let abstract = "";
    if (work.abstract_inverted_index) {
      abstract = reconstructAbstract(work.abstract_inverted_index);
    }

    const isOA = work.open_access?.is_oa || false;
    const oaUrl = work.open_access?.oa_url || "";
    const citedBy = work.cited_by_count || 0;

    let velocity = 0;
    if (pubDate && citedBy > 0) {
      const daysSince = Math.max(1, (Date.now() - new Date(pubDate).getTime()) / 86400000);
      velocity = citedBy / daysSince;
    }

    return {
      title: work.display_name || work.title || "Untitled",
      url,
      authors: authors + authorSuffix,
      source,
      date: pubDate,
      summary: abstract,
      cited_by_count: citedBy,
      velocity,
      is_oa: isOA,
      oa_url: oaUrl,
    };
  });

  if (sort === "hot") {
    papers.sort((a, b) => b.velocity - a.velocity);
  }

  papers = papers.slice(0, DISPLAY_COUNT);
  return { papers, totalCount };
}

// ─── Reconstruct abstract from inverted index ───
function reconstructAbstract(invertedIndex) {
  if (!invertedIndex) return "";
  const words = [];
  for (const [word, positions] of Object.entries(invertedIndex)) {
    for (const pos of positions) {
      words[pos] = word;
    }
  }
  const text = words.join(" ");
  if (text.length > 350) {
    return text.slice(0, 350).replace(/\s\S*$/, "") + "\u2026";
  }
  return text;
}

// ─── Compute "hot" threshold ───
function computeHotThreshold(cards) {
  if (!cards.length) return Infinity;
  const velocities = cards.map(c => c.velocity).filter(v => v > 0);
  if (!velocities.length) return Infinity;
  velocities.sort((a, b) => b - a);
  return velocities[Math.max(0, Math.floor(velocities.length * 0.3) - 1)] || velocities[0];
}

// ─── Format date nicely ───
function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// ─── Render cards ───
function renderCards(cards, topicLabel, totalCount) {
  if (totalCount !== undefined) {
    const fromY = yearFrom.value;
    const toY = yearTo.value;
    resultCount.textContent = `${cards.length} of ${totalCount.toLocaleString()} results \u00b7 ${fromY}\u2013${toY}`;
    resultInfo.classList.add("visible");
  }

  if (!cards.length) {
    feedEl.innerHTML = `<div class="empty-state">
      <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <p>No results found. Adjust the filters or try another topic.</p>
    </div>`;
    return;
  }

  const hotThreshold = computeHotThreshold(cards);

  feedEl.innerHTML = "";
  cards.forEach((c, i) => {
    const isFirst = i === 0;
    const card = document.createElement("div");
    card.className = isFirst ? "card-hero" : "card";
    card.style.animationDelay = `${i * 0.05}s`;

    const linkUrl = c.is_oa && c.oa_url ? c.oa_url : c.url;
    const titleHtml = linkUrl
      ? `<a href="${escapeHtml(linkUrl)}" target="_blank" rel="noopener">${escapeHtml(c.title)}</a>`
      : escapeHtml(c.title);

    const isHot = c.velocity >= hotThreshold && c.velocity > 0;
    const hotBadge = isHot ? `<span class="badge-hot">\u{1F525} Hot</span>` : "";

    const citeHtml = c.cited_by_count > 0
      ? `<span class="cite-count">${c.cited_by_count} cited</span>`
      : "";

    const oaHtml = c.is_oa ? `<span class="open-access">\u{1F513} Open Access</span>` : "";

    const heroLabel = isFirst ? `<span class="hero-label">\u2B50 Top Pick</span>` : "";

    const yearStr = c.date ? c.date.split("-")[0] : "";
    const yearBadge = yearStr ? `<span class="year-badge">${yearStr}</span>` : "";

    // Build meta items
    const metaParts = [];
    if (c.source) metaParts.push(escapeHtml(c.source));
    if (c.date) metaParts.push(formatDate(c.date));
    if (c.authors) metaParts.push(escapeHtml(c.authors));

    const metaHtml = metaParts.length
      ? `<div class="meta">${metaParts.join('<span class="meta-dot"></span>')}</div>`
      : "";

    const abstractHtml = c.summary
      ? `<div class="abstract">${escapeHtml(c.summary)}</div>`
      : "";

    card.innerHTML = `
      <div class="card-badges">
        ${heroLabel}
        <span class="card-topic">${escapeHtml(topicLabel)}</span>
        ${hotBadge}
        ${yearBadge}
      </div>
      <div class="card-header">
        <h3>${titleHtml}${oaHtml}</h3>
        <div class="card-stats">${citeHtml}</div>
      </div>
      ${metaHtml}
      ${abstractHtml}
    `;
    feedEl.appendChild(card);
  });
}

// ─── Skeletons ───
function showSkeletons() {
  resultInfo.classList.remove("visible");
  feedEl.innerHTML = "";

  // Hero skeleton
  const heroSkel = document.createElement("div");
  heroSkel.className = "skeleton skeleton-hero";
  heroSkel.innerHTML = `
    <div class="skeleton-line"></div>
    <div class="skeleton-line"></div>
    <div class="skeleton-line"></div>
    <div class="skeleton-line"></div>
  `;
  feedEl.appendChild(heroSkel);

  for (let i = 0; i < 5; i++) {
    const s = document.createElement("div");
    s.className = "skeleton";
    s.innerHTML = `
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
    `;
    feedEl.appendChild(s);
  }
}

// ─── Error handling ───
function showError(msg) {
  errorBanner.textContent = msg;
  errorBanner.style.display = "block";
}

function hideError() {
  errorBanner.style.display = "none";
}

// ─── Util ───
function escapeHtml(str) {
  const div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML;
}
</script>

</body>
</html>
