<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Radar — Materials Science Intelligence Briefing</title>
<meta name="description" content="A weekly research intelligence briefing for materials science. Citation velocity rankings, cross-disciplinary signals, institutional clusters, and emerging methods — powered by OpenAlex.">
<meta name="keywords" content="research intelligence, materials science, citation velocity, research briefing, academic papers, OpenAlex, scientific discovery">
<meta name="author" content="Research Radar">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://liiiiikonu.github.io/pocto-garbanzo/">
<meta property="og:type" content="website">
<meta property="og:title" content="Research Radar — Materials Science Intelligence Briefing">
<meta property="og:description" content="A research intelligence tabloid. Citation velocity, cross-disciplinary signals, institutional clusters. Not a search engine — a briefing.">
<meta property="og:url" content="https://liiiiikonu.github.io/pocto-garbanzo/">
<meta property="og:site_name" content="Research Radar">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://liiiiikonu.github.io/pocto-garbanzo/og-image.svg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Research Radar — Materials Science Intelligence Briefing">
<meta name="twitter:description" content="A research intelligence tabloid. Citation velocity, signals, institutional clusters.">
<meta name="twitter:image" content="https://liiiiikonu.github.io/pocto-garbanzo/og-image.svg">
<meta name="theme-color" content="#c8a47e">
<meta name="color-scheme" content="dark">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='4' fill='%23c8a47e'/><circle cx='16' cy='16' r='3.5' fill='%23111'/></svg>">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebApplication","name":"Research Radar","url":"https://liiiiikonu.github.io/pocto-garbanzo/","description":"Research intelligence briefing for materials science.","applicationCategory":"EducationalApplication","operatingSystem":"Any","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"},"author":{"@type":"Organization","name":"Research Radar"}}
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Newsreader:opsz,wght@6..72,400;6..72,500;6..72,600;6..72,700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#101010;--bg-r:#161616;--bg-e:#1c1c1c;--bg-o:#242424;
  --brd-s:rgba(255,255,255,0.055);--brd:rgba(255,255,255,0.09);--brd-st:rgba(255,255,255,0.15);
  --t1:#e0ddd8;--t2:#a09a90;--t3:#706b63;--t4:#4a4740;
  --acc:#c8a47e;--acc-d:rgba(200,164,126,0.1);--acc-m:rgba(200,164,126,0.22);
  --sage:#6b9e78;--sage-d:rgba(107,158,120,0.1);
  --steel:#7a9bb5;--steel-d:rgba(122,155,181,0.1);
  --coral:#b87060;--err:#b85555;--err-d:rgba(184,85,85,0.1);
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;line-height:1.55;overflow-x:hidden;-webkit-font-smoothing:antialiased}

.grain{position:fixed;inset:0;z-index:9999;pointer-events:none;opacity:0.028;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");background-size:200px}

/* ── Masthead ── */
.masthead{border-bottom:1px solid var(--brd-s);padding:0.6rem 2rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;position:sticky;top:0;z-index:100;background:rgba(16,16,16,0.92);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px)}
.mast-left{display:flex;align-items:center;gap:0.75rem}
.wordmark{font-family:'Newsreader',Georgia,serif;font-size:1.1rem;font-weight:700;letter-spacing:-0.03em;color:var(--t1)}
.edition-line{font-size:0.6rem;color:var(--t4);text-transform:uppercase;letter-spacing:0.08em;font-weight:500}
.dot-live{width:5px;height:5px;border-radius:50%;background:var(--sage);box-shadow:0 0 5px rgba(107,158,120,0.5);animation:pulse 3s ease-in-out infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.35}}
.mast-right{display:flex;align-items:center;gap:0.5rem}
.mast-timer{font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--t4);min-width:30px;text-align:right}
.mast-btn{background:none;border:1px solid var(--brd);color:var(--t3);width:26px;height:26px;border-radius:3px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s;font-size:0.78rem}
.mast-btn:hover{border-color:var(--brd-st);color:var(--t2)}
.mast-btn:disabled{opacity:0.3;cursor:not-allowed}
.mast-select{background:var(--bg-r);border:1px solid var(--brd);color:var(--t2);font:0.7rem/1 'Inter',sans-serif;padding:0.3rem 0.4rem;border-radius:3px;cursor:pointer;outline:none}

/* ── Period nav ── */
.period-bar{border-bottom:1px solid var(--brd-s);padding:0 2rem;display:flex;align-items:stretch;gap:0;overflow-x:auto;scrollbar-width:none}
.period-bar::-webkit-scrollbar{display:none}
.period-tab{padding:0.55rem 1rem;font-size:0.72rem;font-weight:500;color:var(--t3);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all 0.15s;white-space:nowrap;font-family:inherit}
.period-tab:hover{color:var(--t2)}
.period-tab.active{color:var(--t1);border-bottom-color:var(--acc)}
.period-tab:disabled{opacity:0.3;cursor:not-allowed}

/* ── Signal nav ── */
.signal-bar{padding:0.6rem 2rem;display:flex;align-items:center;gap:0.35rem;border-bottom:1px solid var(--brd-s);overflow-x:auto;scrollbar-width:none}
.signal-bar::-webkit-scrollbar{display:none}
.signal-tab{padding:0.3rem 0.65rem;font-size:0.65rem;font-weight:500;color:var(--t3);background:none;border:1px solid var(--brd-s);border-radius:2px;cursor:pointer;transition:all 0.15s;white-space:nowrap;font-family:inherit}
.signal-tab:hover{color:var(--t2);border-color:var(--brd)}
.signal-tab.active{color:var(--acc);border-color:var(--acc);background:var(--acc-d)}
.signal-tab:disabled{opacity:0.3;cursor:not-allowed}
.signal-tab .sig-count{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--t4);margin-left:0.2rem}

/* ── Content ── */
.content{max-width:1200px;margin:0 auto;padding:0 2rem}
.error-banner{display:none;padding:0.6rem 0.8rem;margin:1rem 0 0;background:var(--err-d);border:1px solid rgba(184,85,85,0.2);border-radius:2px;font-size:0.8rem;color:var(--err)}

/* ── Headline ── */
.headline{padding:2rem 0 1.5rem;border-bottom:2px solid var(--acc);position:relative}
.hl-eyebrow{font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--acc);margin-bottom:0.6rem;display:block}
.hl-title{font-family:'Newsreader',Georgia,serif;font-size:clamp(1.6rem,3.5vw,2.3rem);font-weight:700;line-height:1.22;letter-spacing:-0.03em;margin-bottom:0.6rem;max-width:780px}
.hl-title a{color:var(--t1);text-decoration:none;transition:color 0.15s}
.hl-title a:hover{color:var(--acc)}
.hl-insight{font-size:0.88rem;line-height:1.7;color:var(--t2);max-width:680px;margin-bottom:1rem}
.hl-insight strong{color:var(--t1);font-weight:600}
.hl-meta{font-size:0.72rem;color:var(--t3);margin-bottom:0.75rem}
.hl-meta .hl-src{color:var(--acc);font-weight:500;text-transform:uppercase;letter-spacing:0.03em}
.hl-indicators{display:flex;align-items:stretch;gap:0;flex-wrap:wrap}
.hl-ind{padding:0.5rem 0.85rem;border-right:1px solid var(--brd-s);display:flex;flex-direction:column;gap:0.15rem}
.hl-ind:last-child{border-right:none}
.hl-ind-label{font-size:0.55rem;font-weight:500;text-transform:uppercase;letter-spacing:0.07em;color:var(--t4)}
.hl-ind-value{font-family:'JetBrains Mono',monospace;font-size:0.88rem;font-weight:500;color:var(--t1)}
.hl-ind-bar{width:60px;height:3px;background:var(--bg-o);border-radius:1px;overflow:hidden;margin-top:0.15rem}
.hl-ind-fill{height:100%;background:var(--acc);border-radius:1px}
.hl-ind--accent .hl-ind-value{color:var(--acc)}
.hl-ind--sage .hl-ind-value{color:var(--sage)}

/* ── Columns ── */
.columns{display:grid;grid-template-columns:1fr 1.5fr 240px;gap:0;border-top:1px solid var(--brd-s);margin-top:0.5rem}
.col{padding:1.25rem 0}
.col-left{padding-right:1.25rem;border-right:1px solid var(--brd-s)}
.col-center{padding-left:1.25rem;padding-right:1.25rem;border-right:1px solid var(--brd-s)}
.col-right{padding-left:1.25rem}

.col-heading{font-size:0.58rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--t4);margin-bottom:0.85rem;display:flex;align-items:center;gap:0.4rem}
.col-heading::after{content:'';flex:1;height:1px;background:var(--brd-s)}

/* ── Signal entries (left col) ── */
.sig-entry{padding:0.65rem 0;border-bottom:1px solid var(--brd-s);transition:all 0.12s}
.sig-entry:last-child{border-bottom:none}
.sig-entry:hover{padding-left:0.3rem}
.sig-entry .sig-src{font-size:0.6rem;color:var(--acc);text-transform:uppercase;letter-spacing:0.04em;font-weight:500}
.sig-entry .sig-age{font-size:0.6rem;color:var(--t4)}
.sig-entry .sig-title{font-family:'Newsreader',Georgia,serif;font-size:0.92rem;font-weight:600;line-height:1.3;letter-spacing:-0.01em;margin:0.2rem 0}
.sig-entry .sig-title a{color:var(--t1);text-decoration:none;transition:color 0.15s}
.sig-entry .sig-title a:hover{color:var(--acc)}
.sig-entry .sig-stats{display:flex;align-items:center;gap:0.5rem;margin-top:0.2rem}
.sig-entry .sig-mom{font-family:'JetBrains Mono',monospace;font-size:0.68rem;color:var(--acc);font-weight:500}
.sig-entry .sig-cite{font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--t4)}

/* ── Deep reads (center col) ── */
.deep-entry{padding:1rem 0;border-bottom:1px solid var(--brd-s)}
.deep-entry:last-child{border-bottom:none}
.deep-entry .deep-src{font-size:0.62rem;color:var(--acc);text-transform:uppercase;letter-spacing:0.04em;font-weight:500;margin-bottom:0.25rem;display:block}
.deep-entry .deep-title{font-family:'Newsreader',Georgia,serif;font-size:1.1rem;font-weight:600;line-height:1.32;letter-spacing:-0.015em;margin-bottom:0.3rem}
.deep-entry .deep-title a{color:var(--t1);text-decoration:none;transition:color 0.15s}
.deep-entry .deep-title a:hover{color:var(--acc)}
.deep-entry .deep-authors{font-size:0.72rem;color:var(--t3);margin-bottom:0.4rem}
.deep-entry .deep-abstract{font-size:0.82rem;color:var(--t2);line-height:1.65;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:0.65rem}
.deep-entry .deep-indicators{display:flex;align-items:center;gap:0;flex-wrap:wrap}
.deep-ind{display:flex;flex-direction:column;gap:0.1rem;padding:0.3rem 0.6rem 0.3rem 0;border-right:1px solid var(--brd-s)}
.deep-ind:first-child{padding-left:0}
.deep-ind:last-child{border-right:none}
.deep-ind-label{font-size:0.5rem;font-weight:500;text-transform:uppercase;letter-spacing:0.06em;color:var(--t4)}
.deep-ind-value{font-family:'JetBrains Mono',monospace;font-size:0.75rem;font-weight:500;color:var(--t1)}
.deep-ind-bar{width:50px;height:2px;background:var(--bg-o);border-radius:1px;overflow:hidden;margin-top:0.1rem}
.deep-ind-fill{height:100%;background:var(--acc);border-radius:1px}

/* ── Intelligence panel (right col) ── */
.intel-section{margin-bottom:1.25rem}
.intel-heading{font-size:0.56rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--t4);margin-bottom:0.55rem;display:flex;align-items:center;gap:0.35rem}
.intel-heading::after{content:'';flex:1;height:1px;background:var(--brd-s)}

.intel-metric{display:flex;align-items:baseline;justify-content:space-between;padding:0.2rem 0}
.intel-metric-value{font-family:'JetBrains Mono',monospace;font-size:0.88rem;font-weight:500;color:var(--t1)}
.intel-metric-label{font-size:0.65rem;color:var(--t4)}

.intel-row{display:flex;align-items:center;justify-content:space-between;padding:0.22rem 0;border-bottom:1px solid var(--brd-s);font-size:0.72rem}
.intel-row:last-child{border-bottom:none}
.intel-row-name{color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;margin-right:0.5rem}
.intel-row-count{font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--t4);flex-shrink:0}

.intel-signal{padding:0.25rem 0;border-bottom:1px solid var(--brd-s);display:flex;align-items:center;justify-content:space-between;font-size:0.72rem}
.intel-signal:last-child{border-bottom:none}
.intel-signal-name{color:var(--t2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:0.3rem}
.intel-signal-count{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--acc)}

.dist-chart{display:flex;align-items:flex-end;gap:2px;height:32px}
.dist-bar{flex:1;min-width:0;background:var(--acc);opacity:0.3;border-radius:1px 1px 0 0;transition:opacity 0.2s}
.dist-bar:hover{opacity:0.6}

.toggle-row{display:flex;align-items:center;gap:0.4rem;font-size:0.72rem;color:var(--t3);cursor:pointer;margin-top:0.4rem}
.toggle-row:hover{color:var(--t2)}
.toggle-row input{accent-color:var(--acc);width:12px;height:12px;cursor:pointer}

/* ── Empty / Skeleton ── */
.empty-state{text-align:center;padding:4rem 1rem;color:var(--t4);font-size:0.88rem;grid-column:1/-1}
.skel{padding:1rem 0;border-bottom:1px solid var(--brd-s)}
.skel-lg{padding:1.5rem 0}
.skel-line{height:10px;border-radius:2px;background:linear-gradient(90deg,var(--bg-e) 25%,rgba(255,255,255,0.025) 50%,var(--bg-e) 75%);background-size:200% 100%;animation:shimmer 1.8s ease infinite;margin-bottom:0.5rem}
.skel-line:nth-child(1){width:18%;height:7px}
.skel-line:nth-child(2){width:65%}
.skel-line:nth-child(3){width:45%}
.skel-line:nth-child(4){width:80%;margin-bottom:0}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* ── Footer ── */
footer{padding:1.5rem 2rem;font-size:0.62rem;color:var(--t4);text-align:center;border-top:1px solid var(--brd-s)}
footer a{color:var(--acc);text-decoration:none}

/* ── Responsive ── */
@media(max-width:960px){
  .columns{grid-template-columns:1fr 1fr;}.col-right{grid-column:1/-1;border-right:none;padding-left:0;padding-top:0.5rem;border-top:1px solid var(--brd-s);display:grid;grid-template-columns:1fr 1fr 1fr;gap:0 1.5rem}
  .content{padding:0 1.25rem}.masthead{padding:0.6rem 1.25rem}.period-bar{padding:0 1.25rem}.signal-bar{padding:0.6rem 1.25rem}
}
@media(max-width:720px){
  .columns{grid-template-columns:1fr}.col-left{border-right:none;padding-right:0;border-bottom:1px solid var(--brd-s)}.col-center{padding-left:0;padding-right:0;border-right:none;border-bottom:1px solid var(--brd-s)}.col-right{grid-template-columns:1fr 1fr;gap:0 1rem}
  .masthead{padding:0.5rem 0.75rem;gap:0.5rem}.content{padding:0 0.75rem}.period-bar{padding:0 0.75rem}.signal-bar{padding:0.5rem 0.75rem}
  .edition-line{display:none}.hl-title{font-size:1.4rem}.deep-entry .deep-abstract{-webkit-line-clamp:3}
}
@media(max-width:500px){
  .col-right{grid-template-columns:1fr}.mast-select{display:none}
}

::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:2px}::selection{background:var(--acc-m);color:var(--t1)}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.anim{animation:fadeUp 0.3s ease both}
</style>
</head>
<body>
<div class="grain"></div>

<header class="masthead">
  <div class="mast-left">
    <span class="wordmark">Research Radar</span>
    <span class="dot-live" title="Live — auto-refreshes every 5 min"></span>
    <span class="edition-line" id="editionLine"></span>
  </div>
  <div class="mast-right">
    <select class="mast-select" id="oaSelect" title="Access filter">
      <option value="all">All papers</option>
      <option value="oa">Open access</option>
    </select>
    <span class="mast-timer" id="refreshTimer"></span>
    <button class="mast-btn" id="refreshBtn" title="Refresh now">&#8635;</button>
  </div>
</header>

<nav class="period-bar" id="periodBar"></nav>
<nav class="signal-bar" id="signalBar"></nav>

<div class="content">
  <div class="error-banner" id="errorBanner"></div>
  <div id="mainContent">
    <div class="empty-state">Loading briefing&hellip;</div>
  </div>
</div>

<footer>
  Data from <a href="https://openalex.org" target="_blank" rel="noopener">OpenAlex</a> &mdash; the open catalog of the world's scholarly works.
</footer>

<script>
// ── Config ──
const OPENALEX = 'https://api.openalex.org/works';
const PER_PAGE = 40, REFRESH = 5*60*1000;

const PERIODS = [
  {id:'week',  label:'This Week',   days:7,   sort:'cited_by_count:desc', eyebrow:"THIS WEEK'S FASTEST ACCELERATING PAPER"},
  {id:'month', label:'30 Days',     days:30,  sort:'cited_by_count:desc', eyebrow:"THIS MONTH'S HIGHEST VELOCITY PAPER"},
  {id:'year',  label:'This Year',   days:365, sort:'cited_by_count:desc', eyebrow:"THIS YEAR'S TOP MOVER"},
  {id:'today', label:'Latest',      days:4,   sort:'publication_date:desc', eyebrow:"JUST PUBLISHED"},
];

const SIGNALS = [
  {id:'all',     label:'All Signals'},
  {id:'fastest', label:'Fastest'},
  {id:'cross',   label:'Cross-Field'},
  {id:'methods', label:'Methods'},
  {id:'reviews', label:'Reviews'},
];

const METHOD_KW = ['method','technique','framework','approach','model','algorithm','protocol','strategy','design','simulation','computational','density functional','machine learning','deep learning','neural network'];

// ── State ──
let activePeriod = 0, activeSignal = 0, loading = false;
let allPapers = [], filteredPapers = [];
const cache = {};
let refreshId = null, countdownId = null, refreshCountdown = 0;

// ── DOM ──
const mainEl = document.getElementById('mainContent');
const errorBanner = document.getElementById('errorBanner');
const periodBar = document.getElementById('periodBar');
const signalBar = document.getElementById('signalBar');
const refreshTimer = document.getElementById('refreshTimer');
const refreshBtn = document.getElementById('refreshBtn');
const editionLine = document.getElementById('editionLine');
const oaSelect = document.getElementById('oaSelect');

// ── Init ──
(function init() {
  editionLine.textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'}).toUpperCase() + ' \u00b7 MATERIALS SCIENCE INTELLIGENCE';
  renderPeriodTabs();
  renderSignalTabs();
  refreshBtn.addEventListener('click', () => { if (!loading) forceRefresh() });
  oaSelect.addEventListener('change', () => { if (!loading) forceRefresh() });
  selectPeriod(0);
})();

// ── Period tabs ──
function renderPeriodTabs() {
  periodBar.innerHTML = '';
  PERIODS.forEach((p, i) => {
    const b = document.createElement('button');
    b.className = 'period-tab' + (i === activePeriod ? ' active' : '');
    b.textContent = p.label;
    b.addEventListener('click', () => selectPeriod(i));
    periodBar.appendChild(b);
  });
}

function updatePeriodTabs() {
  periodBar.querySelectorAll('.period-tab').forEach((el, i) => {
    el.classList.toggle('active', i === activePeriod);
    el.disabled = loading;
  });
}

// ── Signal tabs ──
function renderSignalTabs() {
  signalBar.innerHTML = '';
  SIGNALS.forEach((s, i) => {
    const b = document.createElement('button');
    b.className = 'signal-tab' + (i === activeSignal ? ' active' : '');
    b.innerHTML = s.label + '<span class="sig-count"></span>';
    b.addEventListener('click', () => { activeSignal = i; applySignalFilter(); });
    signalBar.appendChild(b);
  });
}

function updateSignalTabs() {
  const counts = computeSignalCounts(allPapers);
  signalBar.querySelectorAll('.signal-tab').forEach((el, i) => {
    el.classList.toggle('active', i === activeSignal);
    el.disabled = loading;
    const cEl = el.querySelector('.sig-count');
    if (cEl) cEl.textContent = counts[i] !== undefined ? counts[i] : '';
  });
}

function computeSignalCounts(papers) {
  return [
    papers.length,
    papers.filter(p => p.isMethod).length,
  ];
}

function applySignalFilter() {
  updateSignalTabs();
  const sig = SIGNALS[activeSignal].id;
  if (sig === 'all') filteredPapers = [...allPapers];
  else if (sig === 'methods') filteredPapers = allPapers.filter(p => p.isMethod);
  filteredPapers.sort((a, b) => b.velocity - a.velocity);
  renderTabloid(filteredPapers);
}

// ── Select period ──
async function selectPeriod(i) {
  if (loading) return;
  activePeriod = i;
  activeSignal = 0;
  hideError();
  updatePeriodTabs();
  const period = PERIODS[i];
  const key = period.id + '|' + oaSelect.value;

  if (cache[key] && Date.now() - cache[key].ts < REFRESH) {
    allPapers = cache[key].papers;
    applySignalFilter();
    startRefresh();
    return;
  }

  loading = true;
  updatePeriodTabs();
  updateSignalTabs();
  showSkeletons();

  try {
    const papers = await fetchPapers(period);
    cache[key] = { papers, ts: Date.now() };
    allPapers = papers;
    applySignalFilter();
    startRefresh();
  } catch(e) {
    showError(e.message || 'Failed to load briefing.');
    mainEl.innerHTML = '';
  } finally {
    loading = false;
    updatePeriodTabs();
    updateSignalTabs();
  }
}

// ── Refresh ──
function startRefresh() { stopRefresh(); refreshCountdown = REFRESH/1000; updateTimerDisplay(); countdownId = setInterval(() => { refreshCountdown--; updateTimerDisplay() }, 1000); refreshId = setTimeout(forceRefresh, REFRESH) }
function stopRefresh() { clearTimeout(refreshId); clearInterval(countdownId) }
function updateTimerDisplay() { if (refreshCountdown <= 0) { refreshTimer.textContent = '...'; return } const m = Math.floor(refreshCountdown/60), s = refreshCountdown%60; refreshTimer.textContent = m+':'+String(s).padStart(2,'0') }
function forceRefresh() { if (loading) return; delete cache[PERIODS[activePeriod].id + '|' + oaSelect.value]; selectPeriod(activePeriod) }

// ── Fetch ──
function buildUrl(period) {
  const p = new URLSearchParams();
  p.set('per_page', PER_PAGE);
  p.set('mailto', 'research-radar@users.noreply.github.com');
  const now = new Date(), from = new Date(now - period.days * 864e5);
  let f = `type:article|review,from_publication_date:${fmt(from)},to_publication_date:${fmt(now)}`;
  if (oaSelect.value === 'oa') f += ',open_access.is_oa:true';
  p.set('filter', f);
  p.set('search', 'materials science');
  p.set('sort', period.sort);
  return OPENALEX + '?' + p;
}

function fmt(d) { return d.toISOString().split('T')[0] }

async function fetchPapers(period) {
  const r = await fetch(buildUrl(period));
  if (!r.ok) throw new Error('OpenAlex returned ' + r.status);
  const d = await r.json();
  let papers = (d.results || []).map(w => {
    const au = (w.authorships||[]).slice(0,4).map(a => a.author?.display_name).filter(Boolean).join(', ');
    const suf = (w.authorships||[]).length > 4 ? ' et al.' : '';
    const url = w.doi || w.primary_location?.landing_page_url || w.ids?.openalex || '';
    const src = w.primary_location?.source?.display_name || '';
    const date = w.publication_date || '';
    let abs = ''; if (w.abstract_inverted_index) abs = rebuildAbstract(w.abstract_inverted_index);
    const oa = w.open_access?.is_oa || false;
    const oaUrl = w.open_access?.oa_url || '';
    const cited = w.cited_by_count || 0;
    const daysSince = date ? Math.max(1, (Date.now() - new Date(date)) / 864e5) : 1;
    const vel = cited / daysSince;
    const concepts = (w.concepts||[]).filter(c => c.score > 0.3).map(c => ({name:c.display_name, level:c.level, score:c.score}));
    const topFields = new Set(concepts.filter(c => c.level === 0).map(c => c.name));
    const institutions = [...new Set((w.authorships||[]).flatMap(a => (a.institutions||[]).map(inst => inst.display_name)).filter(Boolean))];
    const type = w.type || 'article';
    const titleLower = (w.display_name||'').toLowerCase();
    return {
      title: w.display_name||w.title||'Untitled', url, authors: au+suf, source: src, date, summary: abs,
      cited_by_count: cited, velocity: vel, daysSince, is_oa: oa, oa_url: oaUrl,
      concepts, topFields, institutions, type,
      isCrossField: topFields.size >= 3,
      isMethod: METHOD_KW.some(kw => titleLower.includes(kw)),
      isReview: type === 'review',
      isFastest: false, // computed below
    };
  });

  papers.sort((a, b) => b.velocity - a.velocity);
  const velThreshold = papers.length >= 4 ? papers[Math.floor(papers.length * 0.25)].velocity : 0;
  papers.forEach(p => { p.isFastest = p.velocity >= velThreshold && p.velocity > 0 });
  return papers;
}

function rebuildAbstract(inv) {
  if (!inv) return '';
  const w = [];
  for (const [word, pos] of Object.entries(inv)) for (const p of pos) w[p] = word;
  const t = w.join(' ');
  return t.length > 600 ? t.slice(0, 600).replace(/\s\S*$/, '') + '\u2026' : t;
}

// ── Intelligence computation ──
function computeIntel(papers) {
  const total = papers.length;
  const cites = papers.reduce((s,p) => s + p.cited_by_count, 0);
  const avgVel = total ? papers.reduce((s,p) => s + p.velocity, 0) / total : 0;
  const oaPct = total ? Math.round(papers.filter(p => p.is_oa).length / total * 100) : 0;
  const sorted = [...papers].sort((a,b) => a.cited_by_count - b.cited_by_count);
  const median = total ? sorted[Math.floor(total/2)].cited_by_count : 0;
  const uniqueInst = new Set(papers.flatMap(p => p.institutions)).size;

  // Top sources
  const srcMap = {};
  papers.forEach(p => { if (p.source) srcMap[p.source] = (srcMap[p.source]||0)+1 });
  const topSources = Object.entries(srcMap).sort((a,b) => b[1]-a[1]).slice(0, 5);

  // Top institutions
  const instMap = {};
  papers.forEach(p => p.institutions.forEach(i => { instMap[i] = (instMap[i]||0)+1 }));
  const topInst = Object.entries(instMap).sort((a,b) => b[1]-a[1]).slice(0, 6);

  // Rising signals (level 2+ concepts)
  const sigMap = {};
  papers.forEach(p => p.concepts.filter(c => c.level >= 2).forEach(c => { sigMap[c.name] = (sigMap[c.name]||0)+1 }));
  const risingSignals = Object.entries(sigMap).sort((a,b) => b[1]-a[1]).slice(0, 8);

  return { total, cites, avgVel, oaPct, median, uniqueInst, topSources, topInst, risingSignals };
}

function percentile(paper, papers) {
  const rank = papers.filter(p => p.cited_by_count < paper.cited_by_count).length;
  return Math.round((rank / Math.max(1, papers.length)) * 100);
}

// ── Render ──
function renderTabloid(papers) {
  if (!papers.length) {
    mainEl.innerHTML = '<div class="empty-state">No papers match this signal filter for the selected period.</div>';
    return;
  }

  mainEl.innerHTML = '';
  const maxVel = Math.max(...papers.map(p => p.velocity), 0.001);
  const period = PERIODS[activePeriod];
  const intel = computeIntel(allPapers); // always compute from full set

  // ── Headline ──
  const lead = papers[0];
  const hlEl = document.createElement('section');
  hlEl.className = 'headline anim';
  const link = lead.is_oa && lead.oa_url ? lead.oa_url : lead.url;
  const titleH = link ? `<a href="${esc(link)}" target="_blank" rel="noopener">${esc(lead.title)}</a>` : esc(lead.title);
  const mom = Math.round((lead.velocity / maxVel) * 99) || 0;
  const pctl = percentile(lead, allPapers);
  const daysAgo = Math.round(lead.daysSince);

  let insightText = '';
  if (lead.source && lead.cited_by_count > 0) {
    insightText = `Published in <strong>${esc(lead.source)}</strong> ${daysAgo === 0 ? 'today' : daysAgo === 1 ? 'yesterday' : daysAgo + ' days ago'}. Accumulated <strong>${lead.cited_by_count.toLocaleString()}</strong> citations at <strong>${lead.velocity.toFixed(1)}</strong>/day — placing it at the <strong>${pctl}th percentile</strong> of ${period.label.toLowerCase()} papers.`;
    if (lead.isCrossField) insightText += ` Spans ${lead.topFields.size} top-level fields: ${[...lead.topFields].slice(0,3).join(', ')}.`;
  } else if (lead.source) {
    insightText = `Published in <strong>${esc(lead.source)}</strong> ${daysAgo <= 1 ? 'recently' : daysAgo + ' days ago'}.`;
  }

  hlEl.innerHTML = `
    <span class="hl-eyebrow">${period.eyebrow}</span>
    <h1 class="hl-title">${titleH}</h1>
    <p class="hl-meta"><span class="hl-src">${esc(lead.source)}</span> &middot; ${esc(lead.authors)}</p>
    ${insightText ? `<p class="hl-insight">${insightText}</p>` : ''}
    <div class="hl-indicators">
      <div class="hl-ind hl-ind--accent"><span class="hl-ind-label">Momentum</span><span class="hl-ind-value">${mom}</span><div class="hl-ind-bar"><div class="hl-ind-fill" style="width:${mom}%"></div></div></div>
      <div class="hl-ind"><span class="hl-ind-label">Citations</span><span class="hl-ind-value">${lead.cited_by_count.toLocaleString()}</span></div>
      <div class="hl-ind"><span class="hl-ind-label">Velocity</span><span class="hl-ind-value">${lead.velocity.toFixed(1)}/d</span></div>
      <div class="hl-ind"><span class="hl-ind-label">Impact</span><span class="hl-ind-value">Top ${100-pctl}%</span></div>
      ${lead.is_oa ? '<div class="hl-ind hl-ind--sage"><span class="hl-ind-label">Access</span><span class="hl-ind-value">Open</span></div>' : ''}
    </div>`;
  mainEl.appendChild(hlEl);

  // ── Columns ──
  const colsEl = document.createElement('div');
  colsEl.className = 'columns anim';
  colsEl.style.animationDelay = '0.08s';

  // Assign papers to columns
  const signalPapers = papers.slice(1, 7);  // left: quick signals
  const deepPapers = papers.slice(7, 11);    // center: deep reads

  // Left column
  const leftCol = document.createElement('div');
  leftCol.className = 'col col-left';
  leftCol.innerHTML = '<div class="col-heading">Quick Signals</div>';

  if (!signalPapers.length) {
    leftCol.innerHTML += '<div style="font-size:0.78rem;color:var(--t4);padding:1rem 0">No additional papers.</div>';
  }
  signalPapers.forEach(p => {
    const lk = p.is_oa && p.oa_url ? p.oa_url : p.url;
    const th = lk ? `<a href="${esc(lk)}" target="_blank" rel="noopener">${esc(p.title)}</a>` : esc(p.title);
    const m = Math.round((p.velocity / maxVel) * 99) || 0;
    const d = Math.round(p.daysSince);
    const el = document.createElement('div');
    el.className = 'sig-entry';
    el.innerHTML = `
      <span class="sig-src">${esc(p.source)}</span> <span class="sig-age">&middot; ${d <= 1 ? 'today' : d + 'd ago'}</span>
      <div class="sig-title">${th}</div>
      <div class="sig-stats">
        <span class="sig-mom">M:${m}</span>
        <span class="sig-cite">${p.cited_by_count.toLocaleString()} cited</span>
        ${p.is_oa ? '<span style="font-size:0.58rem;color:var(--sage);font-weight:600;text-transform:uppercase;letter-spacing:0.04em">OA</span>' : ''}
        ${p.isCrossField ? '<span style="font-size:0.58rem;color:var(--steel);font-weight:500;text-transform:uppercase;letter-spacing:0.04em">Cross-field</span>' : ''}
      </div>`;
    leftCol.appendChild(el);
  });
  colsEl.appendChild(leftCol);

  // Center column
  const centerCol = document.createElement('div');
  centerCol.className = 'col col-center';
  centerCol.innerHTML = '<div class="col-heading">Deep Reads</div>';

  if (!deepPapers.length && signalPapers.length < 7) {
    // Use remaining papers from signal list
    const extra = papers.slice(Math.min(7, papers.length), Math.min(11, papers.length));
    if (extra.length) deepPapers.push(...extra);
  }

  if (!deepPapers.length) {
    centerCol.innerHTML += '<div style="font-size:0.78rem;color:var(--t4);padding:1rem 0">Select a broader period for more results.</div>';
  }
  deepPapers.forEach(p => {
    const lk = p.is_oa && p.oa_url ? p.oa_url : p.url;
    const th = lk ? `<a href="${esc(lk)}" target="_blank" rel="noopener">${esc(p.title)}</a>` : esc(p.title);
    const m = Math.round((p.velocity / maxVel) * 99) || 0;
    const pct = percentile(p, allPapers);
    const el = document.createElement('div');
    el.className = 'deep-entry';
    el.innerHTML = `
      <span class="deep-src">${esc(p.source)}${p.date ? ' &middot; ' + fmtDate(p.date) : ''}</span>
      <h3 class="deep-title">${th}</h3>
      <p class="deep-authors">${esc(p.authors)}</p>
      ${p.summary ? `<p class="deep-abstract">${esc(p.summary)}</p>` : ''}
      <div class="deep-indicators">
        <div class="deep-ind"><span class="deep-ind-label">Momentum</span><span class="deep-ind-value" style="color:var(--acc)">${m}</span><div class="deep-ind-bar"><div class="deep-ind-fill" style="width:${m}%"></div></div></div>
        <div class="deep-ind"><span class="deep-ind-label">Citations</span><span class="deep-ind-value">${p.cited_by_count.toLocaleString()}</span></div>
        <div class="deep-ind"><span class="deep-ind-label">Velocity</span><span class="deep-ind-value">${p.velocity.toFixed(1)}/d</span></div>
        <div class="deep-ind"><span class="deep-ind-label">Impact</span><span class="deep-ind-value">Top ${100-pct}%</span></div>
        ${p.is_oa ? '<div class="deep-ind"><span class="deep-ind-label">Access</span><span class="deep-ind-value" style="color:var(--sage)">Open</span></div>' : ''}
      </div>`;
    centerCol.appendChild(el);
  });
  colsEl.appendChild(centerCol);

  // Right column: Intelligence
  const rightCol = document.createElement('div');
  rightCol.className = 'col col-right';

  // Field Pulse
  rightCol.innerHTML = `
    <div class="intel-section">
      <div class="intel-heading">Field Pulse</div>
      <div class="intel-metric"><span class="intel-metric-label">Avg velocity</span><span class="intel-metric-value">${intel.avgVel.toFixed(1)}/d</span></div>
      <div class="intel-metric"><span class="intel-metric-label">Total citations</span><span class="intel-metric-value">${intel.cites.toLocaleString()}</span></div>
      <div class="intel-metric"><span class="intel-metric-label">Median cites</span><span class="intel-metric-value">${intel.median.toLocaleString()}</span></div>
      <div class="intel-metric"><span class="intel-metric-label">Open access</span><span class="intel-metric-value">${intel.oaPct}%</span></div>
      <div class="intel-metric"><span class="intel-metric-label">Institutions</span><span class="intel-metric-value">${intel.uniqueInst}</span></div>
    </div>`;

  // Rising Signals
  if (intel.risingSignals.length) {
    let sigHtml = '<div class="intel-section"><div class="intel-heading">Rising Signals</div>';
    intel.risingSignals.forEach(([name, count]) => {
      sigHtml += `<div class="intel-signal"><span class="intel-signal-name">${esc(name)}</span><span class="intel-signal-count">${count}</span></div>`;
    });
    sigHtml += '</div>';
    rightCol.innerHTML += sigHtml;
  }

  // Top Sources
  if (intel.topSources.length) {
    let srcHtml = '<div class="intel-section"><div class="intel-heading">Top Sources</div>';
    intel.topSources.forEach(([name, count]) => {
      srcHtml += `<div class="intel-row"><span class="intel-row-name">${esc(name)}</span><span class="intel-row-count">${count}</span></div>`;
    });
    srcHtml += '</div>';
    rightCol.innerHTML += srcHtml;
  }

  // Top Institutions
  if (intel.topInst.length) {
    let instHtml = '<div class="intel-section"><div class="intel-heading">Institutional Leaders</div>';
    intel.topInst.forEach(([name, count]) => {
      instHtml += `<div class="intel-row"><span class="intel-row-name">${esc(name)}</span><span class="intel-row-count">${count}</span></div>`;
    });
    instHtml += '</div>';
    rightCol.innerHTML += instHtml;
  }

  // Citation distribution
  if (allPapers.length) {
    const maxC = Math.max(...allPapers.map(p => p.cited_by_count), 1);
    let distHtml = '<div class="intel-section"><div class="intel-heading">Citation Dist.</div><div class="dist-chart">';
    allPapers.slice(0, 20).forEach(p => {
      const h = Math.max(2, Math.round((p.cited_by_count / maxC) * 32));
      distHtml += `<div class="dist-bar" style="height:${h}px" title="${p.cited_by_count} citations"></div>`;
    });
    distHtml += '</div></div>';
    rightCol.innerHTML += distHtml;
  }

  colsEl.appendChild(rightCol);
  mainEl.appendChild(colsEl);
}

// ── Skeleton ──
function showSkeletons() {
  mainEl.innerHTML = '';
  const s = document.createElement('div');
  s.className = 'skel skel-lg';
  s.innerHTML = '<div class="skel-line"></div><div class="skel-line" style="width:75%"></div><div class="skel-line" style="width:50%"></div><div class="skel-line" style="width:85%"></div>';
  mainEl.appendChild(s);
  for (let i = 0; i < 4; i++) {
    const sk = document.createElement('div');
    sk.className = 'skel';
    sk.innerHTML = '<div class="skel-line"></div><div class="skel-line"></div><div class="skel-line"></div><div class="skel-line"></div>';
    mainEl.appendChild(sk);
  }
}

// ── Error ──
function showError(m) { errorBanner.textContent = m; errorBanner.style.display = 'block' }
function hideError() { errorBanner.style.display = 'none' }

// ── Util ──
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML }
function fmtDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) }
</script>
</body>
</html>
