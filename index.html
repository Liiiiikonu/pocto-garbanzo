<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Radar — Live Materials Science Feed</title>
<style>
  :root {
    --bg: #0b0f1a;
    --surface: #131926;
    --surface2: #1a2236;
    --border: #252f45;
    --text: #e2e8f0;
    --text-muted: #8892a8;
    --accent: #38bdf8;
    --accent-glow: rgba(56, 189, 248, 0.15);
    --green: #34d399;
    --amber: #fbbf24;
    --red: #f87171;
    --orange: #fb923c;
    --radius: 10px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
  }

  /* ── Header ── */
  header {
    border-bottom: 1px solid var(--border);
    padding: 1.25rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
    background: var(--surface);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: .6rem;
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: -.02em;
  }

  .logo svg { flex-shrink: 0; }

  .header-right {
    display: flex;
    align-items: center;
    gap: .75rem;
    font-size: .8rem;
    color: var(--text-muted);
  }

  .live-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: .4; }
  }

  .sort-select {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: .35rem .6rem;
    border-radius: var(--radius);
    font-size: .8rem;
    cursor: pointer;
  }

  .sort-select:focus { outline: none; border-color: var(--accent); }

  /* ── Main layout ── */
  main {
    max-width: 960px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  .intro {
    text-align: center;
    margin-bottom: 2rem;
  }

  .intro h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: .35rem;
  }

  .intro p {
    color: var(--text-muted);
    font-size: .95rem;
  }

  /* ── Topic pills ── */
  .topics {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
    justify-content: center;
    margin-bottom: 2.5rem;
  }

  .pill {
    padding: .5rem 1.1rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    font-size: .875rem;
    cursor: pointer;
    transition: all .2s;
    user-select: none;
    white-space: nowrap;
  }

  .pill:hover {
    border-color: var(--accent);
    color: var(--text);
    background: var(--surface2);
  }

  .pill.active {
    border-color: var(--accent);
    background: var(--accent-glow);
    color: var(--accent);
    font-weight: 600;
  }

  .pill:disabled {
    opacity: .5;
    cursor: not-allowed;
  }

  /* ── Result count + refresh bar ── */
  .result-info {
    display: none;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    font-size: .8rem;
    color: var(--text-muted);
  }

  .result-info.visible { display: flex; }

  .refresh-bar {
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  .refresh-timer {
    font-variant-numeric: tabular-nums;
  }

  .refresh-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: .2rem .5rem;
    border-radius: 6px;
    font-size: .75rem;
    cursor: pointer;
    transition: all .2s;
  }

  .refresh-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .refresh-btn:disabled { opacity: .4; cursor: not-allowed; }

  /* ── Feed ── */
  #feed {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    transition: border-color .2s;
    animation: fadeUp .35s ease both;
  }

  .card:hover { border-color: var(--accent); }

  .card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: .75rem;
    margin-bottom: .35rem;
  }

  .card-badges {
    display: flex;
    align-items: center;
    gap: .4rem;
    margin-bottom: .5rem;
  }

  .card-topic {
    display: inline-block;
    font-size: .7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .06em;
    color: var(--accent);
  }

  .badge-hot {
    display: inline-flex;
    align-items: center;
    gap: .2rem;
    font-size: .65rem;
    font-weight: 700;
    color: var(--orange);
    background: rgba(251, 146, 60, .12);
    border: 1px solid rgba(251, 146, 60, .25);
    padding: .1rem .45rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: .04em;
  }

  .card h3 {
    font-size: 1.05rem;
    font-weight: 600;
    margin-bottom: .35rem;
    line-height: 1.4;
    flex: 1;
  }

  .card h3 a {
    color: var(--text);
    text-decoration: none;
  }

  .card h3 a:hover { color: var(--accent); }

  .card .meta {
    font-size: .8rem;
    color: var(--text-muted);
    margin-bottom: .5rem;
  }

  .card p {
    font-size: .9rem;
    color: var(--text-muted);
    line-height: 1.65;
  }

  .card-stats {
    display: flex;
    align-items: center;
    gap: .5rem;
    flex-shrink: 0;
  }

  .cite-count {
    font-size: .7rem;
    color: var(--amber);
    background: rgba(251, 191, 36, .1);
    border: 1px solid rgba(251, 191, 36, .2);
    padding: .15rem .5rem;
    border-radius: 999px;
    white-space: nowrap;
  }

  .open-access {
    display: inline-block;
    font-size: .65rem;
    font-weight: 600;
    color: var(--green);
    background: rgba(52, 211, 153, .1);
    border: 1px solid rgba(52, 211, 153, .2);
    padding: .1rem .4rem;
    border-radius: 4px;
    margin-left: .5rem;
    vertical-align: middle;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ── Loading skeleton ── */
  .skeleton {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
  }

  .skeleton-line {
    height: 14px;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--surface2) 25%, var(--border) 50%, var(--surface2) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    margin-bottom: .6rem;
  }

  .skeleton-line:nth-child(1) { width: 30%; height: 10px; }
  .skeleton-line:nth-child(2) { width: 80%; }
  .skeleton-line:nth-child(3) { width: 60%; }
  .skeleton-line:nth-child(4) { width: 90%; margin-bottom: 0; }

  @keyframes shimmer {
    0%   { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* ── Empty / Error ── */
  .empty-state {
    text-align: center;
    padding: 4rem 1rem;
    color: var(--text-muted);
  }

  .empty-state svg { margin-bottom: 1rem; opacity: .4; }

  .error-banner {
    background: rgba(248, 113, 113, .1);
    border: 1px solid rgba(248, 113, 113, .3);
    color: var(--red);
    padding: .75rem 1rem;
    border-radius: var(--radius);
    font-size: .875rem;
    margin-bottom: 1rem;
    display: none;
  }

  /* ── Footer ── */
  footer {
    text-align: center;
    padding: 1.5rem;
    font-size: .75rem;
    color: var(--text-muted);
    border-top: 1px solid var(--border);
  }

  footer a { color: var(--accent); text-decoration: none; }
  footer a:hover { text-decoration: underline; }

  /* ── Responsive ── */
  @media (max-width: 640px) {
    header { padding: 1rem; }
    main { padding: 1.5rem 1rem 3rem; }
    .card-header { flex-direction: column; gap: .5rem; }
  }

  /* ── Scrollbar ── */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">
    <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
      <circle cx="14" cy="14" r="13" stroke="#38bdf8" stroke-width="2"/>
      <circle cx="14" cy="14" r="4" fill="#38bdf8"/>
      <line x1="14" y1="1" x2="14" y2="8" stroke="#38bdf8" stroke-width="2" stroke-linecap="round"/>
      <line x1="25" y1="8" x2="19" y2="11.5" stroke="#38bdf8" stroke-width="2" stroke-linecap="round"/>
      <line x1="25" y1="20" x2="19" y2="16.5" stroke="#38bdf8" stroke-width="2" stroke-linecap="round"/>
      <line x1="14" y1="27" x2="14" y2="20" stroke="#38bdf8" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="20" x2="9" y2="16.5" stroke="#38bdf8" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="8" x2="9" y2="11.5" stroke="#38bdf8" stroke-width="2" stroke-linecap="round"/>
    </svg>
    Research Radar
  </div>
  <div class="header-right">
    <div class="live-dot" title="Live — auto-refreshes every 5 min"></div>
    <span>Live Feed</span>
    <select class="sort-select" id="sortSelect" title="Sort results">
      <option value="hot">Hottest</option>
      <option value="recent">Most Recent</option>
      <option value="cited">Most Cited</option>
      <option value="relevant">Most Relevant</option>
    </select>
  </div>
</header>

<!-- Main -->
<main>
  <div class="intro">
    <h2>Live Research Feed</h2>
    <p>Real-time papers from OpenAlex. Auto-refreshes every 5 minutes — no API key needed.</p>
  </div>

  <!-- Topics -->
  <div class="topics" id="topics"></div>

  <!-- Error banner -->
  <div class="error-banner" id="errorBanner"></div>

  <!-- Result info + refresh -->
  <div class="result-info" id="resultInfo">
    <span id="resultCount"></span>
    <div class="refresh-bar">
      <span class="refresh-timer" id="refreshTimer"></span>
      <button class="refresh-btn" id="refreshBtn" title="Refresh now">Refresh</button>
    </div>
  </div>

  <!-- Feed -->
  <div id="feed">
    <div class="empty-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <p>Select a research topic above to get started.</p>
    </div>
  </div>
</main>

<footer>
  Data from <a href="https://openalex.org" target="_blank" rel="noopener">OpenAlex</a>,
  an open catalog of the world's scholarly works.
</footer>

<script>
// ─── Config ───
const TOPICS = [
  {
    label: "High-Entropy Alloys",
    search: "high-entropy alloys",
    concepts: "C2778407723",
  },
  {
    label: "Electrocatalysis",
    search: "electrocatalysis",
    concepts: "C159467904",
  },
  {
    label: "ML for Materials",
    search: "machine learning materials science materials discovery",
  },
  {
    label: "AI in Science",
    search: "artificial intelligence scientific discovery research",
  },
  {
    label: "Engineering Physics",
    search: "engineering physics",
  },
  {
    label: "Trending in MatSci",
    search: "materials science",
    concepts: "C192562407",
  },
];

const OPENALEX_BASE = "https://api.openalex.org/works";
const PER_PAGE = 25;           // Fetch more, then rank locally
const DISPLAY_COUNT = 15;      // Show the top N after scoring
const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes

// ─── State ───
let activeTopic = null;
let loading = false;
const cache = {};
let refreshCountdown = null;
let refreshIntervalId = null;
let countdownIntervalId = null;

// ─── DOM refs ───
const topicsEl     = document.getElementById("topics");
const feedEl       = document.getElementById("feed");
const errorBanner  = document.getElementById("errorBanner");
const sortSelect   = document.getElementById("sortSelect");
const resultInfo   = document.getElementById("resultInfo");
const resultCount  = document.getElementById("resultCount");
const refreshTimer = document.getElementById("refreshTimer");
const refreshBtn   = document.getElementById("refreshBtn");

// ─── Init ───
(function init() {
  renderTopics();

  sortSelect.addEventListener("change", () => {
    if (activeTopic !== null) {
      // Bust cache for this sort and re-fetch
      delete cache[cacheKeyFor(activeTopic)];
      selectTopic(activeTopic);
    }
  });

  refreshBtn.addEventListener("click", () => {
    if (activeTopic !== null && !loading) {
      forceRefresh();
    }
  });

  // Auto-load "Trending in MatSci" on page open
  selectTopic(5);
})();

function cacheKeyFor(index) {
  return TOPICS[index].label + "|" + sortSelect.value;
}

// ─── Auto-refresh ───
function startAutoRefresh() {
  stopAutoRefresh();
  refreshCountdown = REFRESH_INTERVAL / 1000;
  updateCountdownDisplay();

  countdownIntervalId = setInterval(() => {
    refreshCountdown--;
    updateCountdownDisplay();
  }, 1000);

  refreshIntervalId = setTimeout(() => {
    forceRefresh();
  }, REFRESH_INTERVAL);
}

function stopAutoRefresh() {
  clearTimeout(refreshIntervalId);
  clearInterval(countdownIntervalId);
  refreshIntervalId = null;
  countdownIntervalId = null;
}

function updateCountdownDisplay() {
  if (refreshCountdown <= 0) {
    refreshTimer.textContent = "refreshing...";
    return;
  }
  const m = Math.floor(refreshCountdown / 60);
  const s = refreshCountdown % 60;
  refreshTimer.textContent = `${m}:${s.toString().padStart(2, "0")}`;
}

function forceRefresh() {
  if (activeTopic === null || loading) return;
  delete cache[cacheKeyFor(activeTopic)];
  selectTopic(activeTopic);
}

// ─── Render topic pills ───
function renderTopics() {
  topicsEl.innerHTML = "";
  TOPICS.forEach((t, i) => {
    const btn = document.createElement("button");
    btn.className = "pill";
    btn.textContent = t.label;
    btn.addEventListener("click", () => selectTopic(i));
    topicsEl.appendChild(btn);
  });
}

function updatePillStates() {
  const pills = topicsEl.querySelectorAll(".pill");
  pills.forEach((p, i) => {
    p.classList.toggle("active", i === activeTopic);
    p.disabled = loading;
  });
  refreshBtn.disabled = loading;
}

// ─── Select topic ───
async function selectTopic(index) {
  if (loading) return;

  hideError();
  activeTopic = index;
  const topic = TOPICS[index];
  const sort = sortSelect.value;
  const key = cacheKeyFor(index);

  // Check cache (use refresh interval as TTL)
  if (cache[key] && Date.now() - cache[key].ts < REFRESH_INTERVAL) {
    renderCards(cache[key].cards, topic.label, cache[key].totalCount);
    updatePillStates();
    startAutoRefresh();
    return;
  }

  loading = true;
  updatePillStates();
  showSkeletons();

  try {
    const { papers, totalCount } = await fetchFromOpenAlex(topic, sort);
    cache[key] = { cards: papers, ts: Date.now(), totalCount };
    renderCards(papers, topic.label, totalCount);
    startAutoRefresh();
  } catch (err) {
    showError(err.message || "Something went wrong.");
    feedEl.innerHTML = "";
    resultInfo.classList.remove("visible");
  } finally {
    loading = false;
    updatePillStates();
  }
}

// ─── Build OpenAlex URL ───
function buildOpenAlexUrl(topic, sort) {
  const params = new URLSearchParams();
  params.set("per_page", PER_PAGE);
  params.set("mailto", "research-radar@users.noreply.github.com");

  // Date filter: last 6 months for freshness
  const now = new Date();
  const sixMonthsAgo = new Date(now);
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
  const fromDate = sixMonthsAgo.toISOString().split("T")[0];

  let filter = `from_publication_date:${fromDate},type:article|review`;

  if (topic.concepts) {
    filter += `,concepts.id:${topic.concepts}`;
  }

  params.set("filter", filter);
  params.set("search", topic.search);

  // API-level sort — for "hot" we fetch by citations then re-rank locally
  switch (sort) {
    case "hot":
      params.set("sort", "cited_by_count:desc");
      break;
    case "cited":
      params.set("sort", "cited_by_count:desc");
      break;
    case "relevant":
      params.set("sort", "relevance_score:desc");
      break;
    case "recent":
    default:
      params.set("sort", "publication_date:desc");
      break;
  }

  return `${OPENALEX_BASE}?${params.toString()}`;
}

// ─── Fetch from OpenAlex ───
async function fetchFromOpenAlex(topic, sort) {
  const url = buildOpenAlexUrl(topic, sort);
  const resp = await fetch(url);

  if (!resp.ok) {
    throw new Error(`OpenAlex returned ${resp.status}. Try again in a moment.`);
  }

  const data = await resp.json();
  const totalCount = data.meta?.count || 0;

  let papers = (data.results || []).map(work => {
    // Authors
    const authors = (work.authorships || [])
      .slice(0, 4)
      .map(a => a.author?.display_name)
      .filter(Boolean)
      .join(", ");
    const authorSuffix = (work.authorships || []).length > 4 ? " et al." : "";

    // Best URL: prefer DOI, then landing page
    let url = "";
    if (work.doi) {
      url = work.doi;
    } else if (work.primary_location?.landing_page_url) {
      url = work.primary_location.landing_page_url;
    } else if (work.ids?.openalex) {
      url = work.ids.openalex;
    }

    // Source / journal
    const source = work.primary_location?.source?.display_name || "";

    // Publication date
    const pubDate = work.publication_date || "";

    // Abstract
    let abstract = "";
    if (work.abstract_inverted_index) {
      abstract = reconstructAbstract(work.abstract_inverted_index);
    }

    // Open access
    const isOA = work.open_access?.is_oa || false;
    const oaUrl = work.open_access?.oa_url || "";

    // Citation velocity: citations per day since publication
    const citedBy = work.cited_by_count || 0;
    let velocity = 0;
    if (pubDate && citedBy > 0) {
      const daysSince = Math.max(1, (Date.now() - new Date(pubDate).getTime()) / 86400000);
      velocity = citedBy / daysSince;
    }

    return {
      title: work.display_name || work.title || "Untitled",
      url,
      authors: authors + authorSuffix,
      source,
      date: pubDate,
      summary: abstract,
      cited_by_count: citedBy,
      velocity,
      is_oa: isOA,
      oa_url: oaUrl,
    };
  });

  // For "hot" sort: re-rank by citation velocity (citations/day)
  if (sort === "hot") {
    papers.sort((a, b) => b.velocity - a.velocity);
  }

  // Take top N
  papers = papers.slice(0, DISPLAY_COUNT);

  return { papers, totalCount };
}

// ─── Reconstruct abstract from inverted index ───
function reconstructAbstract(invertedIndex) {
  if (!invertedIndex) return "";
  const words = [];
  for (const [word, positions] of Object.entries(invertedIndex)) {
    for (const pos of positions) {
      words[pos] = word;
    }
  }
  const text = words.join(" ");
  if (text.length > 300) {
    return text.slice(0, 300).replace(/\s\S*$/, "") + "...";
  }
  return text;
}

// ─── Compute "hot" threshold for badges ───
function computeHotThreshold(cards) {
  if (!cards.length) return Infinity;
  const velocities = cards.map(c => c.velocity).filter(v => v > 0);
  if (!velocities.length) return Infinity;
  velocities.sort((a, b) => b - a);
  // Top 30% get the badge
  return velocities[Math.max(0, Math.floor(velocities.length * 0.3) - 1)] || velocities[0];
}

// ─── Render cards ───
function renderCards(cards, topicLabel, totalCount) {
  if (totalCount !== undefined) {
    resultCount.textContent = `${cards.length} of ${totalCount.toLocaleString()} results · last 6 months`;
    resultInfo.classList.add("visible");
  }

  if (!cards.length) {
    feedEl.innerHTML = `<div class="empty-state"><p>No results found. Try another topic or sort.</p></div>`;
    return;
  }

  const hotThreshold = computeHotThreshold(cards);

  feedEl.innerHTML = "";
  cards.forEach((c, i) => {
    const card = document.createElement("div");
    card.className = "card";
    card.style.animationDelay = `${i * 0.04}s`;

    const meta = [c.source, c.date, c.authors].filter(Boolean).join(" · ");

    const linkUrl = c.is_oa && c.oa_url ? c.oa_url : c.url;
    const titleHtml = linkUrl
      ? `<a href="${escapeHtml(linkUrl)}" target="_blank" rel="noopener">${escapeHtml(c.title)}</a>`
      : escapeHtml(c.title);

    const isHot = c.velocity >= hotThreshold && c.velocity > 0;
    const hotBadge = isHot ? `<span class="badge-hot">HOT</span>` : "";

    const citeHtml = c.cited_by_count > 0
      ? `<span class="cite-count">${c.cited_by_count} cited</span>`
      : "";

    const oaHtml = c.is_oa ? `<span class="open-access">Open Access</span>` : "";

    card.innerHTML = `
      <div class="card-badges">
        <span class="card-topic">${escapeHtml(topicLabel)}</span>
        ${hotBadge}
      </div>
      <div class="card-header">
        <h3>${titleHtml}${oaHtml}</h3>
        <div class="card-stats">${citeHtml}</div>
      </div>
      ${meta ? `<div class="meta">${escapeHtml(meta)}</div>` : ""}
      ${c.summary ? `<p>${escapeHtml(c.summary)}</p>` : ""}
    `;
    feedEl.appendChild(card);
  });
}

// ─── Skeletons ───
function showSkeletons() {
  resultInfo.classList.remove("visible");
  feedEl.innerHTML = "";
  for (let i = 0; i < 6; i++) {
    const s = document.createElement("div");
    s.className = "skeleton";
    s.innerHTML = `
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
    `;
    feedEl.appendChild(s);
  }
}

// ─── Error handling ───
function showError(msg) {
  errorBanner.textContent = msg;
  errorBanner.style.display = "block";
}

function hideError() {
  errorBanner.style.display = "none";
}

// ─── Util ───
function escapeHtml(str) {
  const div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML;
}
</script>

</body>
</html>
